<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Verify & Print Sale Deed – PRTU</title>
  <style>
    /* Page / general layout */
    html,body{height:100%;}
    body { font-family:Arial,sans-serif; background:#f3f6f8; margin:0; padding:10px 12px 20px; }
    h2 { text-align:center; color:#003366; margin:6px 0 12px; font-size:20px; }

    /* Flash message */
    .flash-msg { display:none; max-width:680px; margin:0 auto 12px; padding:8px; background:#ffe5e5; color:#cc0000; border:1px solid #cc0000; border-radius:5px; text-align:center; font-size:13px; }

    /* Form */
    form { max-width:420px; margin:0 auto 12px; background:#fff; padding:12px; border-radius:8px; box-shadow:0 0 5px rgba(0,0,0,0.06); }
    .top-bar { position:absolute; top:8px; right:12px; }
    .home-btn { background:#004080; color:#fff; padding:6px 10px; border-radius:4px; text-decoration:none; font-size:13px; }
    .home-btn:hover { background:#0066cc; }

    label { display:block; margin-top:8px; font-weight:700; font-size:13px; }
    input { width:100%; padding:7px; margin-top:6px; border:1px solid #ccc; border-radius:4px; font-size:13px; }
    button { margin-top:12px; padding:9px; background:#003366; color:#fff; border:none; width:100%; border-radius:4px; cursor:pointer; font-size:14px; }

    /* Result / printable card */
    #result { display:none; max-width:960px; margin:6px auto; background:#fff; padding:10px; border:1px solid #000; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .inspector-line { text-align:center; font-weight:700; font-size:20px; margin-bottom:8px; }
    .notary-header { text-align:center; margin-bottom:8px; }
    .notary-header h1 { margin:0; font-size:18px; }
    .notary-header p { margin:3px 0; font-size:12px; }
    .meta-info { margin-bottom:8px; font-size:13px; display:flex; flex-wrap:wrap; gap:8px; }
    .meta-info div { margin:2px 0; min-width:220px; }

    /* Table */
    .exec-table { width:100%; border-collapse:collapse; margin-bottom:8px; font-size:12px; }
    .exec-table th,.exec-table td{ border:1px solid #000; padding:6px; vertical-align:top; }
    .exec-table th { background:#e9e9e9; text-align:left; font-size:13px; }
    .sig-box { width:100%; height:64px; border-bottom:1px solid #000; }
    .contents,.schedule,.consideration{ border:1px solid #000; padding:6px; margin-bottom:6px; font-size:13px; }
    .contents strong,.schedule strong,.consideration strong{ display:block; margin-bottom:4px; }

    /* Image constraints to help fit onto one page */
    img{ max-width:100%; height:auto; display:block; }
    td img{ max-width:160px; }

    /* Print button */
    #printBtn{ background:green; color:#fff; padding:8px 14px; border:none; border-radius:4px; cursor:pointer; display:block; margin:12px auto; }

    /* Reduce spacing for compact print/layout */
    .compact { line-height:1.05; }

    /* Keep result as single printed block and small top margin */
    @media print {
      @page { size: A4 portrait; margin:6mm; }
      body { background:#fff; padding:0; }
      form,#printBtn,.flash-msg,.top-bar { display:none!important; }
      #result { border:none; box-shadow:none; margin:0; padding:2mm; }
      .inspector-line{ font-size:18px; margin-bottom:4px; }
      .notary-header p{ font-size:11px; }
      .meta-info{ gap:6px; }
      .exec-table th,.exec-table td{ padding:5px; font-size:11px; }
      .sig-box{ height:56px; }
      /* Help force everything to fit on a single page — browsers differ; adjust scale if necessary */
      html,body{height:100%}
      /* Use a subtle scale on print to encourage single-page fit. If overflow occurs, user can set 'Shrink to fit' in print dialog. */
      body{transform-origin:top left; transform:scale(0.96);} 
    }

    /* Small-screen adjustments */
    @media (max-width:720px){
      .meta-info div{ min-width:160px; }
      td img{ max-width:120px; }
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <a href="index.html" class="home-btn">Home</a>
  </div>
  <h2>Verify Document</h2>

  <div id="flashMessage" class="flash-msg">❌ No matching record found.</div>

  <form onsubmit="verifyRecord(event)">
    <label>Notary Registered Sr. No.:</label>
    <input type="text" id="notarySrNo" required/>
    <label>Document Number:</label>
    <input type="text" id="docNumber" required/>
    <button type="submit">Verify</button>
  </form>

  <div id="result" class="compact">
    <!-- TOP LINE -->
    <div id="inspectorTop" class="inspector-line">
      <strong>Notary Authorized </strong>
    </div>

    <div class="notary-header">
      <p>Notary Public, Government of India</p>
      <p>N.J House, Cabin B, Hiralal Chotelal compound, Bhaji Market, Old Station Road, Kalyan (West), Thane – 421301</p>
      <p>Email: pandavarchana77@gmail.com | Phone: +91 9220574357</p>
    </div>

    <div class="meta-info">
      <div><strong>Serial Number:</strong> <span id="z_srno"></span></div>
      <div><strong>Document Number:</strong> <span id="z_docno"></span></div>
      <div><strong>Type of Document:</strong> <span id="z_docType"></span></div>
      <!-- Live saved date column -->
      <div><strong>Saved On:</strong> <span id="z_savedOn"></span></div>
    </div>

    <!-- Parties table -->
    <table class="exec-table">
      <thead>
        <tr>
          <th style="width:35%" id="th_purchaser">Executing Parties: Purchaser</th>
          <th style="width:20%">Digital Photo</th>
          <th style="width:20%">Thumb Impression</th>
          <th style="width:25%">Signature</th>
        </tr>
      </thead>
      <tbody id="tbody_purchaser">
        <tr>
          <td id="z_purchaser"></td>
          <td><img id="z_photoP" width="200" alt="Photo Purchaser"></td>
          <td><img id="z_thumbP" width="100" alt="Thumb Purchaser"></td>
          <td><div class="sig-box"></div></td>
        </tr>
      </tbody>

      <thead>
        <tr>
          <th id="th_seller">Executing Parties: Seller</th>
          <th>Digital Photo</th>
          <th>Thumb Impression</th>
          <th>Signature</th>
        </tr>
      </thead>
      <tbody id="tbody_seller">
        <tr>
          <td id="z_seller"></td>
          <td><img id="z_photoS" width="200" alt="Photo Seller"></td>
          <td><img id="z_thumbS" width="100" alt="Thumb Seller"></td>
          <td><div class="sig-box"></div></td>
        </tr>
      </tbody>

      <thead>
        <tr>
          <th colspan="4">SIGNED AND EXECUTED BY ABOVE PARTIES IN PRESENCE OF:</th>
        </tr>
        <tr>
          <th id="th_witness">Executing Parties: Witness</th>
          <th>Digital Photo</th>
          <th>Thumb Impression</th>
          <th>Signature</th>
        </tr>
      </thead>
      <tbody id="tbody_witness">
        <tr>
          <td id="z_witness"></td>
          <td><img id="z_photoW" width="200" alt="Photo Witness"></td>
          <td><img id="z_thumbW" width="100" alt="Thumb Witness"></td>
          <td><div class="sig-box"></div></td>
        </tr>
      </tbody>
    </table>

    <div class="contents"><strong>CONTENTS OF THE DOCUMENT MENTIONED THEREIN:</strong> <span id="z_contents"></span></div>
    <div class="schedule"><strong>SCHEDULE OF PROPERTY:</strong> <span id="z_schedule"></span></div>
    <div class="consideration"><strong>CONSIDERATION OF PROPERTY:</strong> <span id="z_consideration"></span></div>
    <button id="printBtn" onclick="printRecord()">Print / Download</button>
  </div>

  <script>
    function partyHTML(r, keys, labels){
      return keys.map((k,i)=>`<div><strong>${labels[i]}:</strong> ${r[k]||'—'}</div>`).join('');
    }

    function extraRowHTML(person){
      const details = [
        ['Name','name'],
        ['Age','age'],
        ['Occupation','occupation'],
        ['Residing At','address'],
        ['Contact No.','contact'],
        ['Identification','idnumber'],
      ].map(([label,key]) => `<div><strong>${label}:</strong> ${person?.[key] || '—'}</div>`).join('');
      const photo = person?.photo ? `<img src="${person.photo}" width="160">` : '';
      const thumb = person?.thumb ? `<img src="${person.thumb}" width="100">` : '';
      return `
        <tr>
          <td>${details}</td>
          <td>${photo}</td>
          <td>${thumb}</td>
          <td><div class="sig-box"></div></td>
        </tr>`;
    }

    function formatDateISO(iso){
      try{
        const d = new Date(iso);
        if (isNaN(d)) return iso || '—';
        return d.toLocaleString();
      }catch(e){return iso||'—';}
    }

    async function verifyRecord(e){
      e.preventDefault();
      const sr=document.getElementById('notarySrNo').value.trim();
      const dn=document.getElementById('docNumber').value.trim();
      const flash=document.getElementById('flashMessage');
      const result=document.getElementById('result');
      flash.style.display=result.style.display='none';

      try{
        const recs=await (await fetch('/get-users')).json();
        const r=recs.find(u=>u.metaNotarySrNo===sr&&u.metaDocumentNumber===dn);
        if(!r){
          flash.innerText='❌ Record not found.';
          flash.style.display='block';
          return;
        }

        // Inspector line
        const inspector = (r.inspector_name || 'Archana Pandav').trim();
        document.getElementById('inspectorTop').innerHTML = `<strong>Notary Authorized Adv. ${inspector}</strong>`;

        // Meta
        document.getElementById('z_srno').innerText=r.metaNotarySrNo||'';
        document.getElementById('z_docno').innerText=r.metaDocumentNumber||'';
        document.getElementById('z_docType').innerText=r.metaDocumentType||'';

        // Saved Date: check common fields savedAt / createdAt / metaSavedAt or fallback to now
        const savedCandidates = [r.savedAt, r.createdAt, r.metaSavedAt, r.saved_on, r._savedAt, r.savedOn];
        const savedRaw = savedCandidates.find(x=>x!==undefined && x!==null) || new Date().toISOString();
        document.getElementById('z_savedOn').innerText = formatDateISO(savedRaw);

        // Column headings from types
        const tPurch = (r.purchaserType||'Purchaser').trim() || 'Purchaser';
        const tSeller = (r.sellerType||'Seller').trim() || 'Seller';
        const tWitness= (r.witnessType||'Witness').trim()|| 'Witness';

        document.getElementById('th_purchaser').textContent = `Executing Parties: ${tPurch}`;
        document.getElementById('th_seller').textContent    = `Executing Parties: ${tSeller}`;
        document.getElementById('th_witness').textContent   = `Executing Parties: ${tWitness}`;

        // Main rows
        document.getElementById('z_purchaser').innerHTML = partyHTML(r,
          ['purchaserName','purchaserAge','purchaserOccupation','purchaserAddress','purchaserContact','purchaserIdNumber'],
          ['Name','Age','Occupation','Residing At','Contact No.','Identification']
        );
        document.getElementById('z_photoP').src=r.photoP||'';
        document.getElementById('z_thumbP').src=r.thumbP||'';

        document.getElementById('z_seller').innerHTML = partyHTML(r,
          ['sellerName','sellerAge','sellerOccupation','sellerAddress','sellerContact','sellerIdNumber'],
          ['Name','Age','Occupation','Residing At','Contact No.','Identification']
        );
        document.getElementById('z_photoS').src=r.photoS||'';
        document.getElementById('z_thumbS').src=r.thumbS||'';

        document.getElementById('z_witness').innerHTML = partyHTML(r,
          ['witnessName','witnessAge','witnessOccupation','witnessAddress','witnessContact','witnessIdNumber'],
          ['Name','Age','Occupation','Residing At','Contact No.','Identification']
        );
        document.getElementById('z_photoW').src=r.photoW||'';
        document.getElementById('z_thumbW').src=r.thumbW||'';

        // Clear old extra rows
        ['purchaser','seller','witness'].forEach(key=>{
          const tb = document.getElementById(`tbody_${key}`);
          while (tb.rows.length > 1) tb.deleteRow(-1);
        });

        (r.purchaserExtra||[]).forEach(p=>{
          document.getElementById('tbody_purchaser').insertAdjacentHTML('beforeend', extraRowHTML(p));
        });
        (r.sellerExtra||[]).forEach(p=>{
          document.getElementById('tbody_seller').insertAdjacentHTML('beforeend', extraRowHTML(p));
        });
        (r.witnessExtra||[]).forEach(p=>{
          document.getElementById('tbody_witness').insertAdjacentHTML('beforeend', extraRowHTML(p));
        });

        // Footers
        document.getElementById('z_contents').innerText=r.metaDocumentType||'';
        document.getElementById('z_schedule').innerText=r.scheduleOfProperty||'';
        document.getElementById('z_consideration').innerText=r.consideration||'';

        result.style.display='block';

        // Scroll result into view and try to reduce page gap at top
        setTimeout(()=>{document.getElementById('result').scrollIntoView({behavior:'smooth', block:'start'});},50);
      }catch(err){
        console.error(err);
        flash.innerText='❌ Error fetching record.';
        flash.style.display='block';
      }
    }

    function printRecord(){
      // Use native print; print styles attempt to keep everything on one A4 page.
      window.print();
    }
  </script>
</body>
</html>
